#lab08
---
provider: clab
module: [ vlan,vxlan,ospf,bgp,evpn,bfd,lag,vrf,gateway ]
plugin: [ bgp.session ]

defaults.devices.eos.clab.image: "ceos:4.34.2F"

#bgp
bgp.bfd: True
bgp:
  as: 65500
  rr_list: [ s1,s2 ]
  rr_mesh: False

tools:
  edgeshark:
  graphite:

groups:
  mlag_leaf:
    members: [ l1, l2 ]
    config: [ share-loopback.j2 ]
  router:
    members: [ r1 ]  
    config: [ route-map.j2 ]

nodes:
 s1:
  device: eos
  id: 1
  loopback:
    ipv4: 192.168.1.1/32
    ipv6: fd00::192:168:1:1/128
 s2:
  device: eos
  id: 2
  loopback:
    ipv4: 192.168.1.2/32
    ipv6: fd00::192:168:1:2/128
 l1:
  device: eos
  id: 3
  loopback:
    ipv4: 192.168.2.1/32
    ipv6: fd00::192:168:2:1/128
 l2:
  device: eos
  id: 4
  loopback:
    ipv4: 192.168.2.2/32
    ipv6: fd00::192:168:2:2/128
 l3:
  device: eos
  id: 5
  loopback:
    ipv4: 192.168.2.3/32
    ipv6: fd00::192:168:2:3/128
 l4:
  #module: [ vrf,vlan,vxlan,ospf,bgp,evpn,bfd ]
  device: eos
  id: 6
  loopback:
    ipv4: 192.168.2.4/32
    ipv6: fd00::192:168:2:4/128
 r1:
  module: [ bgp ]
  device: frr
  bgp.as: 65100
  bgp.default_originate: True
  id: 7
  loopback:
    ipv4: 192.168.3.1/32
    ipv6: fd00::192:168:3:1/128


 h1:
  id: 11
  module: [ lag ] 
  device: linux
 h2:
  id: 12
  module: [ lag ] 
  device: linux
 h3:
  id: 13
  device: linux
 h4:
  id: 14
  device: linux
 h5:
  id: 15
  device: linux
 h6:
  id: 16
  device: linux


#vrf 
vrfs:
  red:
    ospf: False
    bgp:
    evpn.transit_vni: 10000
#    links: [ r1-l4 ]
  blue:
    ospf: False
    bgp:
    evpn.transit_vni: 10001
#    links: [ r1-l4 ]

#vlan
vlans:
  red:
    gateway: True
    vrf: red
    prefix:
      ipv4: 172.16.1.0/24
      ipv6: fd00::172:16:1:0/116
  blue:
    gateway: True
    vrf: blue
    prefix:
      ipv4: 172.16.2.0/24
      ipv6: fd00::172:16:2:0/116

links:
#spine1-leaf1,2,3,4
  - interfaces:
      - node: s1
        ifname: eth1
        ipv4: 10.1.1.0
        ipv6: fd00::10:1:1:0
        ospf:
          password: 'spine1'
          bfd: true
      - node: l1
        ifname: eth1
        ipv4: 10.1.1.1
        ipv6: fd00::10:1:1:1
        ospf:
          password: 'spine1'
          bfd: true
    prefix:
      ipv4: 10.1.1.0/31
      ipv6: fd00::10:1:1:0/127
  - interfaces:
      - node: s1
        ifname: eth2
        ipv4: 10.1.1.2
        ipv6: fd00::10:1:1:2
        ospf:
          password: 'spine1'
          bfd: true
      - node: l2
        ifname: eth1
        ipv4: 10.1.1.3
        ipv6: fd00::10:1:1:3
        ospf:
          password: 'spine1'
          bfd: true
    prefix:
      ipv4: 10.1.1.2/31
      ipv6: fd00::10:1:1:2/127
  - interfaces:
      - node: s1
        ifname: eth3
        ipv4: 10.1.1.4
        ipv6: fd00::10:1:1:4
        ospf:
          password: 'spine1'
          bfd: true
      - node: l3
        ifname: eth1
        ipv4: 10.1.1.5
        ipv6: fd00::10:1:1:5
        ospf:
          password: 'spine1'
          bfd: true
    prefix:
      ipv4: 10.1.1.4/31
      ipv6: fd00::10:1:1:4/127
  - interfaces:
      - node: s1
        ifname: eth4
        ipv4: 10.1.1.6
        ipv6: fd00::10:1:1:6
        ospf:
          password: 'spine1'
          bfd: true
      - node: l4
        ifname: eth1
        ipv4: 10.1.1.7
        ipv6: fd00::10:1:1:7
        ospf:
          password: 'spine1'
          bfd: true
    prefix:
      ipv4: 10.1.1.6/31
      ipv6: fd00::10:1:1:6/127
#spine2-leaf1,2,3,4
  - interfaces:
      - node: s2
        ifname: eth1
        ipv4: 10.1.2.0
        ipv6: fd00::10:1:2:0
        ospf:
          password: 'spine2'
          bfd: true
      - node: l1
        ifname: eth2
        ipv4: 10.1.2.1
        ipv6: fd00::10:1:2:1
        ospf:
          password: 'spine2'
          bfd: true
    prefix:
      ipv4: 10.1.2.0/31
      ipv6: fd00::10:1:2:0/127
  - interfaces:
      - node: s2
        ifname: eth2
        ipv4: 10.1.2.2
        ipv6: fd00::10:1:2:2
        ospf:
          password: 'spine2'
          bfd: true
      - node: l2
        ifname: eth2
        ipv4: 10.1.2.3
        ipv6: fd00::10:1:2:3
        ospf:
          password: 'spine2'
          bfd: true
    prefix:
      ipv4: 10.1.2.2/31
      ipv6: fd00::10:1:2:2/127
  - interfaces:
      - node: s2
        ifname: eth3
        ipv4: 10.1.2.4
        ipv6: fd00::10:1:2:4
        ospf:
          password: 'spine2'
          bfd: true
      - node: l3
        ifname: eth2
        ipv4: 10.1.2.5
        ipv6: fd00::10:1:2:5
        ospf:
          password: 'spine2'
          bfd: true
    prefix:
      ipv4: 10.1.2.4/31
      ipv6: fd00::10:1:2:4/127
  - interfaces:
      - node: s2
        ifname: eth4
        ipv4: 10.1.2.6
        ipv6: fd00::10:1:2:6
        ospf:
          password: 'spine2'
          bfd: true
      - node: l4
        ifname: eth2
        ipv4: 10.1.2.7
        ipv6: fd00::10:1:2:7
        ospf:
          password: 'spine2'
          bfd: true
    prefix:
      ipv4: 10.1.2.6/31
      ipv6: fd00::10:1:2:6/127
#l1-l2 
  - interfaces:
      - node: l1
        ifname: eth3
        ipv4: 10.0.1.0
        ipv6: fd00::10:0:1:0
        ospf:
          password: 'lag1'
          bfd: true
      - node: l2
        ifname: eth3
        ipv4: 10.0.1.1
        ipv6: fd00::10:0:1:1
        ospf:
          password: 'lag1'
          bfd: true
    prefix:
      ipv4: 10.0.1.0/31
      ipv6: fd00::10:0:1:0/127

#downlink + mlag leaf-1 leaf-2
  - lag:
      members: [l1-l2]
      mlag.peergroup: 1
  - lag:
      members: [h1-l1, h1-l2]
    vlan.access: red
  - lag:
      members: [h2-l1, h2-l2]
    vlan.access: blue
#downlink leaf-3
#host3
  - interfaces:
      - node: h3
        ifname: eth1
      - node: l3
        ifname: eth3
        vlan.access: red
#host4
  - interfaces:
      - node: h4
        ifname: eth1
      - node: l3
        ifname: eth4
        vlan.access: blue

#host5
  - interfaces:
      - node: h5
        ifname: eth1
      - node: l4
        ifname: eth3
        vlan.access: red
#host6
  - interfaces:
      - node: h6
        ifname: eth1
      - node: l4
        ifname: eth4
        vlan.access: blue

#leaf-4 as border leaf to r1 
#  - l4-r1
  - interfaces:
      - node: l4
        vrf: red
        ifname: eth5
        ipv4: 10.0.5.0
        ipv6: fd00::10:0:5:0
      - node: r1
        ifname: eth1
        ipv4: 10.0.5.1
        ipv6: fd00::10:0:5:1
    prefix:
      ipv4: 10.0.5.0/31
      ipv6: fd00::10:0:5:0/127
#  - l4-r1
  - interfaces:
      - node: l4
        vrf: blue
        ifname: eth6
        ipv4: 10.0.5.2
        ipv6: fd00::10:0:5:2
      - node: r1
        ifname: eth2
        ipv4: 10.0.5.3
        ipv6: fd00::10:0:5:3
    prefix:
      ipv4: 10.0.5.2/31
      ipv6: fd00::10:0:5:2/127


validate:
  wait:
    description: Waiting for stabilize
    wait: 45

  ping1:
      description: Pinging H2 from H1
      nodes: [ h1 ]
      devices: [ linux ]
      exec: ping -c 10 h2 -A
      valid: |
        "64 bytes" in stdout

  ping2:    
    description: Pinging H4 from H3
    nodes: [ h3 ]
    devices: [ linux ]
    exec: ping -c 10 h4 -A
    valid: |
      "64 bytes" in stdout

  ping3:    
    description: Pinging ipv6 H1 from H2
    nodes: [ h2 ]
    devices: [ linux ]
    exec: ping6 -c 10 h1 -A
    valid: |
      "64 bytes" in stdout

  ping4:    
    description: Pinging ipv6 H3 from H4
    nodes: [ h4 ]
    devices: [ linux ]
    exec: ping6 -c 10 h3 -A
    valid: |
      "64 bytes" in stdout
